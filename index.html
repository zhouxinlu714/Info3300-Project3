<html>
<head>
    <title>INFO 3300/5100 - Project 3</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<style>
    body{
        font-family: Arial, Helvetica, sans-serif;
    }

    .gridlines line {
        stroke: #ccc;
        stroke-dasharray: 6;
    }

    .gridlines .domain {
        stroke: none;
    }
    .annotation {
        font-size: smaller;
        fill: black;
    }
    .div container{
        width: 1400px;
        position: relative;
    }
</style>
<body>
    <h1>US Developer Career Guide</h1>
    <div class="container">
        <svg id = "line" height="600" width="800"></svg>
        <svg id = "anno" height="600" width="400"></svg>
    </div>
    <!-- <div>
        <button id="selectButton" type="button">backend</button>
    </div> -->
    <div id="button"></div>
    <script>
        const linesvg = d3.select("svg#line");
        const annosvg = d3.select("svg#anno");
        const width = linesvg.attr("width");
        const height = linesvg.attr("height");
        const margin = {top: 70, right: 10, bottom: 30, left: 60};
        const chartWidth = width - margin.left - margin.right;
        const chartHeight = height - margin.top - margin.bottom;
        let annotations = linesvg.append("g").attr("id","annotations");
        let chartArea = linesvg.append("g").attr("id","points")
                        .attr("transform",`translate(${margin.left},${margin.top})`);

        d3.csv("./survey_results_public.csv", d3.autoType).then(data => {
            //import dataset
            var surveyResult = data
            console.log(surveyResult)

            //clean dataset 64464=>7362
            surveyResult = surveyResult.map(function(obj) {
                    return {
                        Country: obj.Country,
                        DevType: obj.DevType,
                        Gender: obj.Gender,
                        EdLevel: obj.EdLevel,
                        LanguageWorkedWith: obj.LanguageWorkedWith,
                        Salary: obj.ConvertedComp,
                        YearsCode: obj.YearsCode,
                        YearsCodePro: obj.YearsCodePro
                    }
                    });

             // clean data
            surveyResult = surveyResult.filter((d) => { return d['Country'] === 'United States' && d['Salary'] != 'NA' && d['Gender'] != 'NA' && d['DevType'] != 'NA' && d['EdLevel'] != 'NA' && d['LanguageWorkedWith'] != 'NA'&& d['Salary'] != 'NA' && d['Salary'] != 0 && d['YearsCode'] != 'NA' && d['YearsCodePro'] != 'NA' });

            var backend = [];
            var frontend = [];
            var fullstack = [];
            var embedded = [];
            var dataScientistEngineer = [];
            var businessAnalyst = [];
            var devOps = [];
            var pm = [];
            surveyResult.forEach(d=>{
                //split devtype string
                d['DevType'] = d['DevType'].split(";");

                //create different dataset
                d['DevType'].forEach((type, i) => {
                    if(type === "Developer, back-end"){
                        backend.push(d)
                    }
                    if(type === "Developer, front-end"){
                        frontend.push(d)
                    }
                    if(type === "Developer, full-stack"){
                        fullstack.push(d)
                    }
                    if(type === "Developer, embedded applications or devices"){
                        embedded.push(d)
                    }
                    if(type === "Engineer, data" || type ==="Data scientist or machine learning specialist"){
                        dataScientistEngineer.push(d)
                    }
                    if(type === "Data or business analyst" ){
                        businessAnalyst.push(d)
                    }
                    if(type === "DevOps specialist" || type === "Engineer, site reliability"){
                        devOps.push(d)
                    }
                    if(type === "Product manager"){
                        pm.push(d)
                    }
                })
            })
            console.log("survey result", surveyResult)

            //axis
            const yearGroupExtent = ['1-2 years','3-5 years','5-10 years','10-15 years','15-20 years','20+ years'];
            const yearGroupScale = d3.scaleBand().domain(yearGroupExtent).range([0, chartWidth]);

            const salaryExtent = d3.extent(surveyResult, d => d['Salary']);
            const salaryScale = d3.scaleLinear().domain([70000,180000]).range([chartHeight, 0]);

            const roleScale = d3.scaleOrdinal(d3.schemeCategory10);

            function compute_salary_group (data) {
              Allyear_salary = {};
              for(i=0;i<yearGroupExtent.length;i++) {
                year_group = yearGroupExtent[i];
                Allyear_salary[year_group] = [];
              }

              data.forEach((d, i) => {
                if (d['YearsCodePro']===1 || d['YearsCodePro']===2) {
                    Allyear_salary['1-2 years'].push(d.Salary);
                } else if (d['YearsCodePro']>=3 && d['YearsCodePro']<=5) {
                    Allyear_salary['3-5 years'].push(d.Salary);
                } else if (d['YearsCodePro']>5 && d['YearsCodePro']<=10) {
                    Allyear_salary['5-10 years'].push(d.Salary);
                } else if (d['YearsCodePro']>10 && d['YearsCodePro']<=15) {
                    Allyear_salary['10-15 years'].push(d.Salary);
                } else if (d['YearsCodePro']>15 && d['YearsCodePro']<=20) {
                    Allyear_salary['15-20 years'].push(d.Salary);
                } else if (d['YearsCodePro'] > 20) {
                    Allyear_salary['20+ years'].push(d.Salary);
                };
              });
              return Allyear_salary;
            };

            var salary_groups = compute_salary_group (surveyResult);
            console.log("salary_groups", salary_groups);

            let leftAxis = d3.axisLeft(salaryScale).tickFormat(d3.format("~f"));
            let leftAxisG = annotations.append("g")
                .attr("class", "y axis")
                .attr("transform", `translate(${margin.left - 10},${margin.top})`)
                .call(leftAxis);
            let leftGridlines = d3.axisLeft(salaryScale)
                    .tickSize(-chartWidth-10)
                    .tickFormat("")
            annotations.append("g")
                        .attr("class", "y gridlines")
                        .attr("transform",`translate(${margin.left-10},${margin.top})`)
                        .call(leftGridlines);
            let bottomAxis = d3.axisBottom(yearGroupScale);
            let bottomAxisG = annotations.append("g")
                .attr("class", "x axis")
                .attr("transform", `translate(${margin.left},${chartHeight + margin.top + 10})`)
                .call(bottomAxis);


            // update function passing data
            function addLinePlot(data, role) {
                year_salary = compute_salary_group (data);
                let year_salary_result = []
                for(i=0;i<yearGroupExtent.length;i++) {
                    let year_group = yearGroupExtent[i];
                    year_salary_result.push({"salary":Math.floor(d3.median(year_salary[year_group])* 100)/100, "year_group":year_group});
                }
                console.log("data",data)
                console.log("year_salary_result", year_salary_result)

                // let circles = chartArea.selectAll("circle.salary_point").data(year_salary_result)
                //         .join(enter => enter.append("circle")
                //         .attr("class", "salary_point")
                //         .attr("stroke", "#6e6a6a")
                //         .attr("stroke-width", 0.8)
                //         .attr("r", 5)
                //         .attr("cx", d => yearGroupScale(d['year_group']) )
                //         .attr("cy", d => salaryScale(d['salary']) )
                //         .attr("fill", "blue" ));

                var lineGen = d3.line()
                                .defined(d => !isNaN(d.salary))
                                .x( d => yearGroupScale(d['year_group']) + yearGroupScale.bandwidth() / 2 )
                                .y( d => salaryScale(d['salary']) )
                                .curve(d3.curveMonotoneX);

                chartArea.append("path")
                        .datum(year_salary_result)
                        .attr("class", "line " + role)
                        .attr("fill", "none")
                        .attr("stroke", roleScale(role))
                        .attr("stroke-width", 3)
                        .attr("d", lineGen);
                
                chartArea.selectAll("circle").select(".lineCircle")
                    .data(year_salary_result)
                    .enter()
                    .append("circle")
                    .attr("cx", d => yearGroupScale(d['year_group']) + yearGroupScale.bandwidth() / 2 )
                    .attr("cy", d => salaryScale(d['salary']))
                    .attr("fill", roleScale(role))
                    .attr("stroke", "#f0f0f0")
                    .attr("stroke-width", 2)
                    .attr("class", "lineCircle " + role)
                    .attr("r", 8);

                let mouseGroup = chartArea.append("g");
                let xMarker = mouseGroup.append("line")
                    .attr("id","xMarker")
                    .attr("fill","none")
                    .attr("stroke","black")
                    .attr("stroke-width",1)
                    .attr("y1",0)
                    .attr("y2",chartHeight)
                    .attr("visibility","hidden");

                let valueMarker = mouseGroup.append("circle")
                    .attr("id","valueMarker")
                    .attr("fill","none")
                    .attr("stroke","steelblue")
                    .attr("stroke-width",2)
                    .attr("r",6)
                    .attr("visibility","hidden");

                let label = mouseGroup.append("text")
                    .attr("id","label")
                    .attr("visibility","hidden");
                let activeRegion = mouseGroup.append("rect")
                    .attr("id","activeRegion")
                    .attr("width",chartWidth)
                    .attr("height",chartHeight)
                    .attr("fill","none")
                    .attr("pointer-events","all");
                
                var rolename = getRoleName(role);  // get full role name
                var language_dict = {};  // count LanguageWorkedWith 
                data.forEach(d=>{
                    entryArray = d.LanguageWorkedWith.split(";");
                    for(i of entryArray){
                        if(i in language_dict){
                            language_dict[i] += 1
                        } else {
                            language_dict[i] = 1
                        }
                    }
                })
                console.log(language_dict)
                const MostL1 = Object.entries(language_dict).reduce((a, b) => a[1] > b[1] ? a : b)[0];
                language_dict[MostL1] = 0;  // remove the largest one
                const MostL2 = Object.entries(language_dict).reduce((a, b) => a[1] > b[1] ? a : b)[0];
                var edu_dict = {};
                data.forEach(d=>{
                    d.EdLevel+="(";
                    edu_level = d.EdLevel.substring(0,d.EdLevel.indexOf("(")-1);
                    if(edu_level in edu_dict) {
                        edu_dict[edu_level] += 1
                    } else {
                        edu_dict[edu_level] = 1
                    }
                })
                console.log(edu_dict);
                var ed_sum = Object.keys(edu_dict).reduce((sum,key)=>sum+parseFloat(edu_dict[key]||0),0);
                const MostED1 = Object.entries(edu_dict).reduce((a, b) => a[1] > b[1] ? a : b)[0];
                const MostED1_prec = Math.floor((edu_dict[MostED1]/ed_sum)*10000)/100;
                edu_dict[MostED1] = 0;
                const MostED2 = Object.entries(edu_dict).reduce((a, b) => a[1] > b[1] ? a : b)[0];
                const MostED2_prec = Math.floor((edu_dict[MostED2]/ed_sum)*10000)/100;
                annosvg.html('');
                annosvg.append("text").text(rolename).attr("x",100).attr("y",100);
                annosvg.append("text").text("Most common language").attr("x",100).attr("y",150);
                annosvg.append("text").text(MostL1).attr("x",100).attr("y",200);
                annosvg.append("text").text(MostL2).attr("x",200).attr("y",200);
                annosvg.append("text").text("Education level").attr("x",100).attr("y",250);
                annosvg.append("text").text(MostED1).attr("x",100).attr("y",300);
                annosvg.append("text").text(MostED1_prec+"%").attr("x",100).attr("y",350);
                annosvg.append("text").text(MostED2).attr("x",100).attr("y",400);
                annosvg.append("text").text(MostED2_prec+"%").attr("x",100).attr("y",450);
                function updateAnno() {

                }
                // activeRegion is now the top-most item (even if invisible), so it should always catch the mouse events and never clash
                activeRegion.on("mouseover", function() {
                // Show the marker and label when mousing over
                    xMarker.attr("visibility","");
                    valueMarker.attr("visibility","");
                    label.attr("visibility","");
                });
                activeRegion.on("mouseout", function() {
                    // Hide them when mousing out of chart
                    xMarker.attr("visibility","hidden");
                    valueMarker.attr("visibility","hidden");
                    label.attr("visibility","hidden");
                });
                activeRegion.on("mousemove", function(evt) {
                    // // Get mouse location
                    let location = d3.pointer(evt);
                    let x = location[0];
                    var eachBand = yearGroupScale.bandwidth();
                    var index;
                    if(x<=+yearGroupScale.bandwidth() / 2) {
                        index = 0;
                    } else if(x<=eachBand+yearGroupScale.bandwidth() / 2) {
                        index = 1;
                    } else if(x<=2*eachBand+yearGroupScale.bandwidth() / 2) {
                        index = 2;
                    } else if(x<=3*eachBand+yearGroupScale.bandwidth() / 2) {
                        index = 3;
                    } else if(x<=4*eachBand+yearGroupScale.bandwidth() / 2) {
                        index = 4;
                    } else {
                        index = 5;
                    }

                    let d = year_salary_result[index];
                    // From there, it's just a matter of updating positions using our scales like we've done for a while now
                    let xPos = yearGroupScale(d['year_group'])+ yearGroupScale.bandwidth() / 2;
                    let yPos =  salaryScale(d['salary']);
                    
                    xMarker.attr("x1",xPos).attr("x2",xPos);
                    valueMarker.attr("cx",xPos).attr("cy",yPos);
                    
                    let txt = d['salary']
                    
                    label.text(txt).attr("class","annotation").attr("x",xPos+10).attr("y",yPos+2).attr("text-anchor","start").attr("dy", ".35em");
                    valueMarker.attr("visibility","");

                });
            }

            function updateLinePlot(data, role) {
                chartArea.selectAll(".line").attr("opacity", 0.2);
                chartArea.selectAll(".lineCircle").attr("opacity", 0.2);
                chartArea.selectAll("." + role).attr("opacity", 1);
            }

            // draw all plots
            addLinePlot(backend, 'backend');
            addLinePlot(frontend, 'frontend');
            addLinePlot(fullstack, 'fullstack');
            addLinePlot(dataScientistEngineer, 'dataScientistEngineer');
            addLinePlot(businessAnalyst, 'businessAnalyst');
            addLinePlot(embedded, 'embedded');
            addLinePlot(devOps, 'devOps');
            addLinePlot(pm, 'pm');

            var menuDiv = d3.select("div#button");
            var Button1 = menuDiv.append("button")
                    .text("Backend developer")
                    .on('click', function(){
                        updateLinePlot(backend, 'backend');
                        addLinePlot(backend, 'backend');
                    });
            var Button2 = menuDiv.append("button")
                    .text("Frontend developer")
                    .on('click', function(){
                        updateLinePlot(frontend, 'frontend');
                        addLinePlot(frontend, 'frontend');
                    });
            var Button3 = menuDiv.append("button")
                    .text("Fullstack developer")
                    .on('click', function(){
                        updateLinePlot(fullstack, 'fullstack');
                        addLinePlot(fullstack, 'fullstack');
                    });
            var Button4 = menuDiv.append("button")
                    .text("Data scientist or data engineer")
                    .on('click', function(){
                        updateLinePlot(dataScientistEngineer, 'dataScientistEngineer');
                        addLinePlot(dataScientistEngineer, 'dataScientistEngineer');
                    });
            var Button5 = menuDiv.append("button")
                    .text("Data or business analyst")
                    .on('click', function(){
                        updateLinePlot(businessAnalyst, 'businessAnalyst');
                        addLinePlot(businessAnalyst, 'businessAnalyst');
                    });
            var Button6 = menuDiv.append("button")
                    .text("Embedded software engineer")
                    .on('click', function(){
                        updateLinePlot(embedded, 'embedded');
                        addLinePlot(embedded, 'embedded');
                    });
            var Button7 = menuDiv.append("button")
                    .text("DevOps or site reliability engineer")
                    .on('click', function(){
                        updateLinePlot(devOps, 'devOps');
                        addLinePlot(devOps, 'devOps');
                    });
            var Button8 = menuDiv.append("button")
                    .text("Product manager")
                    .on('click', function(){
                        updateLinePlot(pm, 'pm');
                        addLinePlot(pm, 'pm');
                    });
            function getRoleName(role) {
                if(role==='backend'){
                    rolename = 'Backend developer'
                }
                if(role==='frontend'){
                    rolename = 'Frontend developer'
                }
                if(role==='fullstack'){
                    rolename = 'Fullstack developer'
                }
                if(role==='dataScientistEngineer'){
                    rolename = 'Data or business analyst'
                }
                if(role==='embedded'){
                    rolename = 'Embedded software engineer'
                }
                if(role==='devOps'){
                    rolename = 'DevOps or site reliability engineer'
                }
                if(role==='businessAnalyst'){
                    rolename = 'Data or business analyst'
                }
                if(role==='pm'){
                    rolename = 'Product manager'
                }
                return rolename;
            }
        })
    </script>
</body>
</html>
