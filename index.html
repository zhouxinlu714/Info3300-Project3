<html>
<head>
    <title>INFO 3300/5100 - Project 3</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<style>
    body{
        font-family: Arial, Helvetica, sans-serif;
    }

    .gridlines line {
        stroke: #ccc;
        stroke-dasharray: 6;
    }

    .gridlines .domain {
        stroke: none;
    }
    .annotation {
        font-size: smaller;
        fill: black;
    }
</style>
<body>
    <h1>US Developer Career Guide</h1>
    <svg id = "line" height="600" width="800"></svg>
    <!-- <div>
        <button id="selectButton" type="button">backend</button>
    </div> -->
    <div id="button"></div>
    <script>
        const linesvg = d3.select("svg#line");
        const width = linesvg.attr("width");
        const height = linesvg.attr("height");
        const margin = {top: 70, right: 10, bottom: 30, left: 60};
        const chartWidth = width - margin.left - margin.right;
        const chartHeight = height - margin.top - margin.bottom;
        let annotations = linesvg.append("g").attr("id","annotations");
        let chartArea = linesvg.append("g").attr("id","points")
                        .attr("transform",`translate(${margin.left},${margin.top})`);

        d3.csv("./survey_results_public.csv", d3.autoType).then(data => {
            //import dataset
            var surveyResult = data
            console.log(surveyResult)

            //clean dataset 64464=>7362
            surveyResult = surveyResult.map(function(obj) {
                    return {
                        Country: obj.Country,
                        DevType: obj.DevType,
                        Gender: obj.Gender,
                        EdLevel: obj.EdLevel,
                        LanguageWorkedWith: obj.LanguageWorkedWith,
                        Salary: obj.ConvertedComp,
                        YearsCode: obj.YearsCode,
                        YearsCodePro: obj.YearsCodePro
                    }
                    });

             // clean data
            surveyResult = surveyResult.filter((d) => { return d['Country'] === 'United States' && d['Salary'] != 'NA' && d['Gender'] != 'NA' && d['DevType'] != 'NA' && d['EdLevel'] != 'NA' && d['LanguageWorkedWith'] != 'NA'&& d['Salary'] != 'NA' && d['Salary'] != 0 && d['YearsCode'] != 'NA' && d['YearsCodePro'] != 'NA' });

            var backend = [];
            var frontend = [];
            var fullstack = [];
            var embedded = [];
            var dataScientistEngineer = [];
            var businessAnalyst = [];
            var devOps = [];
            var pm = [];
            surveyResult.forEach(d=>{
                //split devtype string
                d['DevType'] = d['DevType'].split(";");

                //create different dataset
                d['DevType'].forEach((type, i) => {
                    if(type === "Developer, back-end"){
                        backend.push(d)
                    }
                    if(type === "Developer, front-end"){
                        frontend.push(d)
                    }
                    if(type === "Developer, full-stack"){
                        fullstack.push(d)
                    }
                    if(type === "Developer, embedded applications or devices"){
                        embedded.push(d)
                    }
                    if(type === "Engineer, data" || type ==="Data scientist or machine learning specialist"){
                        dataScientistEngineer.push(d)
                    }
                    if(type === "Data or business analyst" ){
                        businessAnalyst.push(d)
                    }
                    if(type === "DevOps specialist" || type === "Engineer, site reliability"){
                        devOps.push(d)
                    }
                    if(type === "Product manager"){
                        pm.push(d)
                    }
                })
            })
            console.log("survey result", surveyResult)

            //axis
            const yearGroupExtent = ['1-2 years','3-5 years','5-10 years','10-15 years','15-20 years','20+ years'];
            const yearGroupScale = d3.scaleBand().domain(yearGroupExtent).range([0, chartWidth]);

            const salaryExtent = d3.extent(surveyResult, d => d['Salary']);
            const salaryScale = d3.scaleLinear().domain([70000,180000]).range([chartHeight, 0]);

            const roleScale = d3.scaleOrdinal(d3.schemeCategory10);

            function compute_salary_group (data) {
              Allyear_salary = {};
              for(i=0;i<yearGroupExtent.length;i++) {
                year_group = yearGroupExtent[i];
                Allyear_salary[year_group] = [];
              }

              data.forEach((d, i) => {
                if (d['YearsCodePro']===1 || d['YearsCodePro']===2) {
                    Allyear_salary['1-2 years'].push(d.Salary);
                } else if (d['YearsCodePro']>=3 && d['YearsCodePro']<=5) {
                    Allyear_salary['3-5 years'].push(d.Salary);
                } else if (d['YearsCodePro']>5 && d['YearsCodePro']<=10) {
                    Allyear_salary['5-10 years'].push(d.Salary);
                } else if (d['YearsCodePro']>10 && d['YearsCodePro']<=15) {
                    Allyear_salary['10-15 years'].push(d.Salary);
                } else if (d['YearsCodePro']>15 && d['YearsCodePro']<=20) {
                    Allyear_salary['15-20 years'].push(d.Salary);
                } else if (d['YearsCodePro'] > 20) {
                    Allyear_salary['20+ years'].push(d.Salary);
                };
              });
              return Allyear_salary;
            };

            var salary_groups = compute_salary_group (surveyResult);
            console.log("salary_groups", salary_groups);

            let leftAxis = d3.axisLeft(salaryScale).tickFormat(d3.format("~f"));
            let leftAxisG = annotations.append("g")
                .attr("class", "y axis")
                .attr("transform", `translate(${margin.left - 10},${margin.top})`)
                .call(leftAxis);
            let leftGridlines = d3.axisLeft(salaryScale)
                    .tickSize(-chartWidth-10)
                    .tickFormat("")
            annotations.append("g")
                        .attr("class", "y gridlines")
                        .attr("transform",`translate(${margin.left-10},${margin.top})`)
                        .call(leftGridlines);
            let bottomAxis = d3.axisBottom(yearGroupScale);
            let bottomAxisG = annotations.append("g")
                .attr("class", "x axis")
                .attr("transform", `translate(${margin.left},${chartHeight + margin.top + 10})`)
                .call(bottomAxis);


            // update function passing data
            function addLinePlot(data, role) {
                year_salary = compute_salary_group (data);
                let year_salary_result = []
                for(i=0;i<yearGroupExtent.length;i++) {
                    let year_group = yearGroupExtent[i];
                    year_salary_result.push({"salary":Math.floor(d3.median(year_salary[year_group])* 100)/100, "year_group":year_group});
                }
                console.log("year_salary_result", year_salary_result)

                // let circles = chartArea.selectAll("circle.salary_point").data(year_salary_result)
                //         .join(enter => enter.append("circle")
                //         .attr("class", "salary_point")
                //         .attr("stroke", "#6e6a6a")
                //         .attr("stroke-width", 0.8)
                //         .attr("r", 5)
                //         .attr("cx", d => yearGroupScale(d['year_group']) )
                //         .attr("cy", d => salaryScale(d['salary']) )
                //         .attr("fill", "blue" ));

                var lineGen = d3.line()
                                .defined(d => !isNaN(d.salary))
                                .x( d => yearGroupScale(d['year_group']) + yearGroupScale.bandwidth() / 2 )
                                .y( d => salaryScale(d['salary']) )
                                .curve(d3.curveMonotoneX);

                chartArea.append("path")
                        .datum(year_salary_result)
                        .attr("class", "line " + role)
                        .attr("fill", "none")
                        .attr("stroke", roleScale(role))
                        .attr("stroke-width", 3)
                        .attr("d", lineGen);
                
                chartArea.selectAll("circle").select(".lineCircle")
                    .data(year_salary_result)
                    .enter()
                    .append("circle")
                    .attr("cx", d => yearGroupScale(d['year_group']) + yearGroupScale.bandwidth() / 2 )
                    .attr("cy", d => salaryScale(d['salary']))
                    .attr("fill", roleScale(role))
                    .attr("stroke", "#f0f0f0")
                    .attr("stroke-width", 2)
                    .attr("class", "lineCircle " + role)
                    .attr("r", 8);

                console.log(year_salary_result);
                console.log(chartArea.selectAll("circle"))

                let mouseGroup = chartArea.append("g");
                let xMarker = mouseGroup.append("line")
                    .attr("id","xMarker")
                    .attr("fill","none")
                    .attr("stroke","black")
                    .attr("stroke-width",1)
                    .attr("y1",0)
                    .attr("y2",chartHeight)
                    .attr("visibility","hidden");

                let valueMarker = mouseGroup.append("circle")
                    .attr("id","valueMarker")
                    .attr("fill","none")
                    .attr("stroke","steelblue")
                    .attr("stroke-width",2)
                    .attr("r",6)
                    .attr("visibility","hidden");

                let label = mouseGroup.append("text")
                    .attr("id","label")
                    .attr("visibility","hidden");
                let activeRegion = mouseGroup.append("rect")
                    .attr("id","activeRegion")
                    .attr("width",chartWidth)
                    .attr("height",chartHeight)
                    .attr("fill","none")
                    .attr("pointer-events","all");
                    let findDate = d3.bisector( d => d.year ).right;

                // activeRegion is now the top-most item (even if invisible), so it should always catch the mouse events and never clash
                activeRegion.on("mouseover", function() {
                // Show the marker and label when mousing over
                    xMarker.attr("visibility","");
                    valueMarker.attr("visibility","");
                    label.attr("visibility","");
                    });
                    activeRegion.on("mouseout", function() {
                    // Hide them when mousing out of chart
                    xMarker.attr("visibility","hidden");
                    valueMarker.attr("visibility","hidden");
                    label.attr("visibility","hidden");
                });
                activeRegion.on("mousemove", function(evt) {
                // Update the position as you move

                // // Get mouse location
                //     let location = d3.pointer(evt);
                //     let x = location[0];
                //     // Use "invert" on a scale to go from pixels back to data
                //     let xDate = yearGroupScale.invert(x);
                //     // We use the bisector to find the index of the element that's closest to our xDate
                //     let index = findDate(year_salary_result, xDate);
                //     // We can then get d, the data point that's closest
                //     let d = year_salary_result[index];
                //
                //     // From there, it's just a matter of updating positions using our scales like we've done for a while now
                //     let xPos = yearGroupScale(d['year_group']);
                //     let yPos = salaryScale(d['salary']);
                //
                //     xMarker.attr("x1",xPos).attr("x2",xPos);
                //     valueMarker.attr("cx",xPos).attr("cy",yPos);
                //
                //     let txt = d['salary']
                //
                //     // We started with the following line, which has lots of overlaps
                //     // label.attr("x",xPos).attr("y",yPos).text(txt);
                //
                //     // Here's a simple way to remove overlaps and deliver a consistent user experience
                //     if(isNaN(yPos)) {
                //         valueMarker.attr("visibility","hidden");
                //     } else {
                //         label.text(txt).attr("class","annotation").attr("x",xPos+10).attr("y",yPos+2).attr("text-anchor","start").attr("dy", ".35em");
                //         valueMarker.attr("visibility","");
                //     }

                // if (xPos < chartWidth / 2.0) {
                //     label.attr("x",xPos+4).attr("y",100).attr("text-anchor","start");
                // }
                // else {
                //     label.attr("x",xPos-4).attr("y",chartHeight-100).attr("text-anchor","end");
                });
            }

            function updateLinePlot(data, role) {
                chartArea.selectAll(".line").attr("opacity", 0.2);
                chartArea.selectAll(".lineCircle").attr("opacity", 0.2);
                chartArea.selectAll("." + role).attr("opacity", 1);
            }

            // draw all plots
            addLinePlot(backend, 'backend');
            addLinePlot(frontend, 'frontend');
            addLinePlot(fullstack, 'fullstack');
            addLinePlot(dataScientistEngineer, 'dataScientistEngineer');
            addLinePlot(businessAnalyst, 'businessAnalyst');
            addLinePlot(embedded, 'embedded');
            addLinePlot(devOps, 'devOps');
            addLinePlot(pm, 'pm');

            var menuDiv = d3.select("div#button");
            var Button1 = menuDiv.append("button")
                    .text("Backend developer")
                    .on('click', function(){
                        updateLinePlot(backend, 'backend');
                    });
            var Button2 = menuDiv.append("button")
                    .text("Frontend developer")
                    .on('click', function(){
                        updateLinePlot(frontend, 'frontend');
                    });
            var Button3 = menuDiv.append("button")
                    .text("Fullstack developer")
                    .on('click', function(){
                        updateLinePlot(fullstack, 'fullstack');
                    });
            var Button4 = menuDiv.append("button")
                    .text("Data scientist or data engineer")
                    .on('click', function(){
                        updateLinePlot(dataScientistEngineer, 'dataScientistEngineer');
                    });
            var Button5 = menuDiv.append("button")
                    .text("Data or business analyst")
                    .on('click', function(){
                        updateLinePlot(businessAnalyst, 'businessAnalyst');
                    });
            var Button6 = menuDiv.append("button")
                    .text("Embedded software engineer")
                    .on('click', function(){
                        updateLinePlot(embedded, 'embedded');
                    });
            var Button7 = menuDiv.append("button")
                    .text("DevOps or site reliability engineer")
                    .on('click', function(){
                        updateLinePlot(devOps, 'devOps');
                    });
            var Button8 = menuDiv.append("button")
                    .text("Product manager")
                    .on('click', function(){
                        updateLinePlot(pm, 'pm');
                    });
        })
    </script>
</body>
</html>
